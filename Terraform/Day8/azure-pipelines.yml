# ============================================================
# Day 8 — CI/CD for Terraform (Azure DevOps)
# Pipeline: Validate → Plan (PR) → Manual Approval → Apply (main)
# FIX: Stage 4 no longer downloads artifact from PR run
#      Instead re-runs plan + applies directly on main
# ============================================================

trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  terraformVersion: "1.6.0"
  workingDirectory: "Terraform/Day8"
  serviceConnection: "azure-service-connection"
  backendResourceGroup: "rg-tfstate"
  backendStorageAccount: "stgtfstate2606"
  backendContainer: "tfstate"
  backendKey: "rg-demo-test.tfstate"

# ============================================================
# STAGE 1 — VALIDATE
# Runs on both PR and main push
# ============================================================
stages:
  - stage: Validate
    displayName: "1 - Validate & Format Check"
    jobs:
      - job: ValidateTerraform
        displayName: "Terraform Validate"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - bash: |
              wget -q https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
              unzip -q terraform_$(terraformVersion)_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform version
            displayName: "Install Terraform $(terraformVersion)"

          - task: AzureCLI@2
            displayName: "terraform init"
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(workingDirectory)
              addSpnToEnvironment: true
              inlineScript: |
                export ARM_CLIENT_ID=$servicePrincipalId
                export ARM_OIDC_TOKEN=$idToken
                export ARM_TENANT_ID=$tenantId
                export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                export ARM_USE_OIDC=true
                terraform init \
                  -backend-config="resource_group_name=$(backendResourceGroup)" \
                  -backend-config="storage_account_name=$(backendStorageAccount)" \
                  -backend-config="container_name=$(backendContainer)" \
                  -backend-config="key=$(backendKey)"

          - bash: |
              echo "Running terraform fmt check..."
              terraform fmt -check -recursive
              if [ $? -ne 0 ]; then
                echo "##vso[task.logissue type=error]Formatting issues found. Run: terraform fmt -recursive"
                exit 1
              fi
              echo "Format check passed!"
            displayName: "terraform fmt -check"
            workingDirectory: $(workingDirectory)

          - bash: |
              terraform validate
            displayName: "terraform validate"
            workingDirectory: $(workingDirectory)

  # ============================================================
  # STAGE 2 — PLAN (PR ONLY)
  # Publishes artifact so reviewers can read what will change
  # ============================================================
  - stage: Plan
    displayName: "2 - Terraform Plan (PR Only)"
    dependsOn: Validate
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: PlanTerraform
        displayName: "Terraform Plan"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - bash: |
              wget -q https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
              unzip -q terraform_$(terraformVersion)_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform version
            displayName: "Install Terraform $(terraformVersion)"

          - task: AzureCLI@2
            displayName: "terraform init"
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(workingDirectory)
              addSpnToEnvironment: true
              inlineScript: |
                export ARM_CLIENT_ID=$servicePrincipalId
                export ARM_OIDC_TOKEN=$idToken
                export ARM_TENANT_ID=$tenantId
                export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                export ARM_USE_OIDC=true
                terraform init \
                  -backend-config="resource_group_name=$(backendResourceGroup)" \
                  -backend-config="storage_account_name=$(backendStorageAccount)" \
                  -backend-config="container_name=$(backendContainer)" \
                  -backend-config="key=$(backendKey)"

          - task: AzureCLI@2
            displayName: "terraform plan"
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(workingDirectory)
              addSpnToEnvironment: true
              inlineScript: |
                export ARM_CLIENT_ID=$servicePrincipalId
                export ARM_OIDC_TOKEN=$idToken
                export ARM_TENANT_ID=$tenantId
                export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                export ARM_USE_OIDC=true
                terraform plan -out=tfplan
                terraform show -no-color tfplan > tfplan.txt
                echo "Plan complete. Reviewers can read tfplan.txt in the artifact."

          - task: PublishBuildArtifacts@1
            displayName: "Publish Plan Artifact (for reviewer reference)"
            inputs:
              PathtoPublish: "$(workingDirectory)"
              ArtifactName: "terraform-plan"
              publishLocation: "Container"

  # ============================================================
  # STAGE 3 — MANUAL APPROVAL GATE
  # ============================================================
  - stage: WaitForApproval
    displayName: "3 - Manual Approval Gate"
    dependsOn: Plan
    condition: |
      and(
        in(dependencies.Plan.result, 'Succeeded', 'Skipped'),
        eq(variables['Build.SourceBranch'], 'refs/heads/main')
      )
    jobs:
      - deployment: ApprovalGate
        displayName: "Waiting for Manual Approval"
        environment: "production-approval"
        pool:
          vmImage: "ubuntu-latest"
        strategy:
          runOnce:
            deploy:
              steps:
                - bash: echo "Approval received. Proceeding to Apply..."
                  displayName: "Approval Confirmed"

  # ============================================================
  # STAGE 4 — APPLY (MAIN BRANCH ONLY, AFTER APPROVAL)
  # FIX: No artifact download — re-runs init + plan + apply
  #      directly from source code on the main branch agent
  #      This avoids the cross-run artifact not found error
  # ============================================================
  - stage: Apply
    displayName: "4 - Terraform Apply (Main Only)"
    dependsOn: WaitForApproval
    condition: |
      and(
        in(dependencies.WaitForApproval.result, 'Succeeded', 'Skipped'),
        eq(variables['Build.SourceBranch'], 'refs/heads/main')
      )
    jobs:
      - job: ApplyTerraform
        displayName: "Terraform Apply"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - bash: |
              wget -q https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
              unzip -q terraform_$(terraformVersion)_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform version
            displayName: "Install Terraform $(terraformVersion)"

          - task: AzureCLI@2
            displayName: "terraform init"
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(workingDirectory)
              addSpnToEnvironment: true
              inlineScript: |
                export ARM_CLIENT_ID=$servicePrincipalId
                export ARM_OIDC_TOKEN=$idToken
                export ARM_TENANT_ID=$tenantId
                export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                export ARM_USE_OIDC=true
                terraform init \
                  -backend-config="resource_group_name=$(backendResourceGroup)" \
                  -backend-config="storage_account_name=$(backendStorageAccount)" \
                  -backend-config="container_name=$(backendContainer)" \
                  -backend-config="key=$(backendKey)"

          # Re-plan on main then immediately apply
          # This is the correct approach — no stale artifact from a different run
          - task: AzureCLI@2
            displayName: "terraform plan + apply"
            inputs:
              azureSubscription: $(serviceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(workingDirectory)
              addSpnToEnvironment: true
              inlineScript: |
                export ARM_CLIENT_ID=$servicePrincipalId
                export ARM_OIDC_TOKEN=$idToken
                export ARM_TENANT_ID=$tenantId
                export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                export ARM_USE_OIDC=true
                terraform plan -out=tfplan
                terraform apply -auto-approve tfplan
